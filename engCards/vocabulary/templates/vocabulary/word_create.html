{%extends 'base.html'%}
{%load static%}
{%block header%}
<script src="{% static 'js/bs_form.js' %}"></script>
{%endblock%}
{%block content%}
<div class="content-center">
    <div class="content-inner">
        <div class="modal-header">
            <h5 class="modal-title">Создать новое слово</h5>
        </div>
        <div class="d-flex ">
            <form method="POST" action="http://127.0.0.1:8000/vocabulary/words/" id="create-word-form"
            class="mt-4">
            <div class="invalid-feedback non-field-invalid-feedback"></div>
            <div class="mb-3">
                <label for="en" class="form-label">Слово на английском</label>
                <input type="text" class="form-control" id="en" name="en" required>
                <div class="invalid-feedback"></div>
            </div>
            <div class="mb-3">
                <label for="ru" class="form-label">Перевод на русский</label>
                <input type="text" class="form-control" id="ru" name="ru" required value="1">
                <div class="invalid-feedback"></div>
            </div>
            <button type="submit" class="btn btn-primary submit">
                Сохранить</button>
        </form>
        </div>
    </div>
</div>
{%endblock%}
{%block bottom%}
<script>
    var csrf = '{{csrf_token}}'
    async function requestJson(url, method, data) {
        if (!url.startsWith('http')){
            url = location.protocol + '//' + location.host + url
            console.info('fix url', url)
        }
        try {
            let headers = {
                "Content-Type": "application/json",
                "X-CSRFToken": csrf,
                // "Authorization": "Basic " + btoa(`admin:2030`),

            };
            var response = await fetch(url, {
                method: method,
                headers: headers,
                body: JSON.stringify(data),
            });
            return response
            // if (!response.ok) {
            //     var msg = `Response status: ${response.status}\n`
            //     for (const [key, value] of Object.entries(await response.json())) {
            //         msg = msg + `${key}:${value}\n`
            //     }
            //     throw new Error(msg);
            // }

            // const text = await response.text();
            // try {
            //     return JSON.parse(text);
            // } catch {
            //     return text;
            // }
        } catch (error) {
            console.error(error);
            window.alert(error);
            return undefined;
        }
    }
    function formDataToDict(formData) {
        return Object.fromEntries(formData.entries());
    }



</script>

<script>
    const createWordPairForm = document.getElementById('create-word-form')
    createWordPairForm.addEventListener('submit', async function (e) {
        e.preventDefault()
        let formData = new FormData(this);
        var data = formDataToDict(formData)
        var form = e.target
        var submitButton = form.querySelector('button')
        var buttonText = addSpinerInSubmitButton(submitButton)
        disableForm(form)
        var responce = await requestJson(e.target.action, 'POST', data)
        enableForm(form)
        removeSpinerFromButton(submitButton, buttonText)
        if (responce.ok) {
            window.alert('Created word' + await responce.json())
        } else {
            var error_data = await responce.json()
            addErrorsInForm(form, error_data)
        }
    })



</script>
<script>
    document.querySelectorAll('input.form-control').forEach(elem => {  // нет поддержки других типов элементов
        elem.addEventListener('input', () => removeIsInvalid(elem))
    })
</script>
{%endblock%}